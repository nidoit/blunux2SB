#!/bin/bash
# /usr/bin/startblunux — blunux2 Live Session Entry Point
#
# Called by SDDM auto-login or manually. Launches the Rust wizard binary
# which handles hardware detection, config loading, and desktop launch.
#
# Stack: Bash (this script) → Rust (blunux-wizard) → C (fallback)
# No Python or Julia.

set -euo pipefail

CONFIG_FILE="/usr/share/blunux/config.toml"

# Log to journald
exec > >(systemd-cat -t blunux-wizard) 2>&1

echo "blunux2: Starting setup wizard..."
echo "blunux2: Config file: ${CONFIG_FILE}"

# Verify the wizard binary exists
if ! command -v blunux-wizard &>/dev/null; then
    echo "ERROR: blunux-wizard not found in PATH"
    echo "Falling back to direct desktop launch..."
    exec startplasma-wayland
fi

# Launch Rust wizard binary directly.
# It detects hardware, loads config.toml, applies settings,
# then exec's startplasma-wayland (replacing this process tree).
blunux-wizard

# If wizard exits without exec-ing the desktop (error case), launch directly
echo "WARNING: Wizard exited without launching desktop. Starting Plasma directly..."
exec startplasma-wayland
