#!/bin/bash
# /usr/bin/startblunux — blunux2 Live Session Entry Point
#
# Called by SDDM auto-login or manually. Flow:
#   1. blunux-wizard   — hardware detection, locale, keyboard (Rust)
#   2. blunux-setup    — install AUR packages (calamares, kime, etc.) (Rust)
#   3. startplasma     — launch desktop
#
# No Python or Julia.

set -euo pipefail

CONFIG_FILE="/usr/share/blunux/config.toml"

# Log to journald
exec > >(systemd-cat -t blunux-live) 2>&1

echo "blunux2: Starting live session setup..."
echo "blunux2: Config: ${CONFIG_FILE}"

# ── Step 1: Hardware detection + locale ─────────────────────────────────────
if command -v blunux-wizard &>/dev/null; then
    echo "blunux2: Running hardware wizard..."
    # wizard detects GPU, applies locale/keyboard, but does NOT exec desktop
    # (we need to run blunux-setup first)
    blunux-wizard --no-desktop || echo "WARNING: wizard returned non-zero"
else
    echo "WARNING: blunux-wizard not found, skipping hardware detection"
fi

# ── Step 2: Install AUR packages (calamares, input method, etc.) ────────────
if command -v blunux-setup &>/dev/null; then
    echo "blunux2: Running setup (AUR packages)..."
    blunux-setup --live --config "${CONFIG_FILE}" || echo "WARNING: blunux-setup returned non-zero"
elif [[ -x /usr/bin/blunux-setup ]]; then
    echo "blunux2: Running setup script..."
    /usr/bin/blunux-setup --live "${CONFIG_FILE}" || echo "WARNING: blunux-setup returned non-zero"
else
    echo "WARNING: blunux-setup not found, skipping AUR package installation"
fi

# ── Step 3: Launch desktop ──────────────────────────────────────────────────
echo "blunux2: Launching Plasma Wayland..."
exec startplasma-wayland
